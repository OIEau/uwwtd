<?php
require_once 'uwwtd.stats.inc';

function uwwtd_stats_graphs_page(){

	$form = drupal_get_form('uwwtd_stats_graphs_form');

	return render($form);
}

function uwwtd_stats_graphs_form($form, &$form_state){

	$form['#prefix'] = '<h1 align="center">' . t('Graphs for national stats') . '</h1>';
	$form['description'] = array('#markup' => t('<p>Select the year to generate the graphs.</p>'));

	// Get available years for data
		$query = db_select('field_data_field_anneedata', 'a');
		$query->fields('a', array('field_anneedata_value'));
		$query->orderBy('field_anneedata_value', 'DESC');
		$results = $query->execute();
		$years = array('all' => 'Show all');
		while($record = $results->fetchAssoc()) {
			$years[$record['field_anneedata_value']] = $record['field_anneedata_value'];
		}
		$form['year'] = array(
				'#title' => t('Available years'),
				'#type' => 'select',
				'#options' => $years,
				'#default_value' => isset($form_state['values']['year']) ? $form_state['values']['year'] : 'all',
		);



		$form['submit'] = array(
				'#type' => 'submit',
				'#attributes' => array('class' => array('btn-primary', 'btn')),
				'#value' => t('Refresh graphs')
		);

		if(isset($form_state['storage']['result'])) {
			$form['#suffix'] .= $form_state['storage']['result'];
		}

	return $form;

}

/**
 * Form validation.
 */
function uwwtd_stats_graphs_form_validate(&$form, &$form_state) {


}



/**
 * Form submit.
 */
function uwwtd_stats_graphs_form_submit(&$form, &$form_state) {

	$form_state['rebuild'] = TRUE;

	$options = array(
			'year' => $form_state['values']['year'],
	);

	$table = uwwtd_page_stats_graphs_result($options);
	$form_state['storage']['result'] = $table;

}



function uwwtd_page_stats_graphs_result($options){

	drupal_add_js('sites/all/libraries/d3/d3.v3.min.js');
	drupal_add_js(drupal_get_path('module', 'uwwtd') . '/lib/flip/jquery.flip.min.js');
	drupal_add_js(drupal_get_path('module', 'uwwtd') . '/js/uwwtd.js');

	$formResult = "";

	$formResult = '<h1 align="center">'.$title.'</h1>';
	if(isset($option['year'])){
		$year =$option['year'];
	}
	else{
		$year = uwwtd_get_max_annee();
	}
	$formResult.='<p>'.uwwtd_get_national_stat_str($year).'</p>';
	
	//==============================================
    //=============== ROW Collection
    //==============================================
    
    $collect_type = uwwtd_stat_collect_data($options);
	$all = array_shift($collect_type);
	//unset($collect_type[0]);
    //$collect_type_chart = uwwtd_stat_national_ms_level_preprocess_collect_chart($ms_level, $options['year']);
	$collect_type_str = '';
	if(!empty($collect_type)){
		$lines= array();
		$sum = 0;
		$sum_rate = 0;
		foreach($collect_type as $v){
			$lines[]=array(
				$v['label'],
				$v['valueformat'],
				round($v['value']/$all['value']*100 ,1) .' %'
			);
			$sum+=$v['value']; 
			$sum_rate+= round($v['value']/$all['value']*100);
		}
		$lines[]=array('Total', uwwtd_format_number($sum).' pe', uwwtd_format_number($sum_rate).' %');
		$collect_type_str = theme('table', array("rows"=>$lines, "header"=>array("Destination","Values", "Rate")));
	}
	
	
	$sewage = uwwtd_stat_sewage_network_data($options);
	if(!empty($sewage)){
		$lines= array();
		foreach($sewage['sum'] as $k=>$v){
			$lines[]=array(
				$v['label'],
				$v['valueformat'],
				$sewage['count'][$k]['valueformat']
			);
		}
		$sewage_str = theme('table', array("rows"=>$lines, "header"=>array("Network type","Load", "Number of agglomeration")));
	}
   // $ww_reuse = uwwtd_stat_national_ms_level_preprocess_ww_reuse_chart($ms_level, $options['year']);
    $formResult.='<h2 style="clear:both;">Agglomeration : Generated load by collection</h2>';
    $formResult.='<div class="rows charts-row">';
        //Collection destination
        $front = '<svg id="graph_collect_type" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($collect_type).",'graph_collect_type','middle');});</script>";
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Generated Load by collection type", $front, $collect_type_str).'</div></div>';
        //Collective system type
        $front = '<svg id="graph_cs_type" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($sewage['sum']).",'graph_cs_type','middle');});</script>";
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Generated Load by sewage network type", $front, $sewage_str).'</div></div>';
    $formResult.='</div>';
	
	unset($collect_type,  $collect_type_str, $sewage);
	
    //==============================================
    //=============== ROW 1
    //==============================================
    	// Total generated by compliance
	$Data_uwwtd_stat_national_compliance = array();
	$String_uwwtd_stat_national_compliance = array();

	$results = uwwtd_stat_national_compliance($options);
	$sum=0;
	foreach ($results as $result){
		$Data_uwwtd_stat_national_compliance[] = array(
				"value" => $result['generated_sum'],
				"label" => $result['field_aggcompliance_value_format'] .' ['.$result['generated_sum'].' pe]',
				"valueformat" => $result['generated_sum_format'].' pe',
                "color"=>isset($result['color'])?$result['color']:null
		);
		$sum+=$result['generated_sum'];
		$String_uwwtd_stat_national_compliance[]= array($result['field_aggcompliance_value_format'], $result['generated_sum_format'] . ' pe');
	}
	$String_uwwtd_stat_national_compliance[]= array('Total',uwwtd_format_number($sum) . ' pe');
   $String_uwwtd_stat_national_compliance = theme('table', array("rows"=>$String_uwwtd_stat_national_compliance,"header"=>array("Compliance state", "Generated load")));
    
	// Total agglomerations by compliance
	$Data_uwwtd_stat_agglomeration_compliance = array();
	$String_uwwtd_stat_agglomeration_compliance = array();

	$results = uwwtd_stat_national_compliance($options);
	foreach ($results as $result){
		$sum=0;
		$Data_uwwtd_stat_agglomeration_compliance[] = array(
				"value" => $result['total_count'],
				"label" => $result['field_aggcompliance_value_format'] .' ['.$result['total_count'].']',
				"valueformat" => $result['total_count_format'],
                "color"=>isset($result['color'])?$result['color']:null
		);
		$sum=$result['total_count'];
		$String_uwwtd_stat_agglomeration_compliance[]= array($result['field_aggcompliance_value_format'],$result['total_count_format']);
	}
	$String_uwwtd_stat_agglomeration_compliance[]= array('Total',$sum);
    $String_uwwtd_stat_agglomeration_compliance = theme('table', array("rows"=>$String_uwwtd_stat_agglomeration_compliance,"header"=>array("Compliance state", "Number")));
    
    $formResult.='<h2 style="clear:both;">Agglomeration : Generated load by compliance</h2>';
    $formResult.='<div class="rows charts-row">';
        //Total generated load by compliance
        $front = '<svg id="graph_generatedByCompliance" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($Data_uwwtd_stat_national_compliance).",'graph_generatedByCompliance','end');});</script>";
        
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Total generated load by compliance", $front, $String_uwwtd_stat_national_compliance).'</div></div>';
        //Number of agglomerations by compliance
        $front = '<svg id="graph_agglomerationByCompliance" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($Data_uwwtd_stat_agglomeration_compliance).",'graph_agglomerationByCompliance','end');});</script>";
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Number of agglomerations by compliance", $front, $String_uwwtd_stat_agglomeration_compliance).'</div></div>';
    $formResult.='</div>';

    //==============================================
    //=============== ROW 2
    //==============================================
    //Total load entering by compliance

	$aData_uwwtd_stat_national_uwwtpC = array();
	$aString_uwwtd_stat_national_uwwtpC = array();

	$results = uwwtd_stat_national_uwwtp($options,'compliance');
	$sum =0;
	foreach ($results as $result){
		$aData_uwwtd_stat_national_uwwtpC[] = array(
				"value" => $result['loadentering_sum'],
				"label" => $result['field_uwwcompliance_value_format'].' ['.$result['loadentering_sum'].' pe]',
				"valueformat" => $result['loadentering_sum_format'].' pe',
                "color"=>isset($result['color'])?$result['color']:null
		);
		$sum+=$result['loadentering_sum'];
		$aString_uwwtd_stat_national_uwwtpC[]= array($result['field_uwwcompliance_value_format'] , $result['loadentering_sum_format'] . ' pe');
	}
	$aString_uwwtd_stat_national_uwwtpC[]= array('Total',uwwtd_format_number($sum) . ' pe');
	$aString_uwwtd_stat_national_uwwtpC = theme('table', array("rows"=>$aString_uwwtd_stat_national_uwwtpC,"header"=>array("Compliance state", "Load entering")));
   
	//Load entering by compliance : total agglomerations

	$aData_uwwtd_stat_agglomeration_uwwtpC = array();
	$aString_uwwtd_stat_agglomeration_uwwtpC = array();

	$results = uwwtd_stat_national_uwwtp($options,'compliance');
	$sum =0;
	foreach ($results as $result){
		$aData_uwwtd_stat_agglomeration_uwwtpC[] = array(
				"value" => $result['total_count'],
				"label" => $result['field_uwwcompliance_value_format'] .' ['.$result['total_count'].']',
				"valueformat" => $result['total_count_format'],
                "color"=>isset($result['color'])?$result['color']:null
		);
		$sum+=$result['total_count'];
		$aString_uwwtd_stat_agglomeration_uwwtpC[]= array($result['field_uwwcompliance_value_format'], $result['total_count_format'] );
	}
	$aString_uwwtd_stat_agglomeration_uwwtpC[]= array('Total',uwwtd_format_number($sum));
    $aString_uwwtd_stat_agglomeration_uwwtpC = theme('table', array("rows"=>$aString_uwwtd_stat_agglomeration_uwwtpC,"header"=>array("Compliance state", "Number")));
    
    $formResult.='<h2 style="clear:both;">Waste water treatement plant : Load entering by compliance</h2>';
    $formResult.='<div class="rows charts-row">';
        //Total load entering by compliance
        $front = '<svg id="graph_loadenteringByCompliance" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($aData_uwwtd_stat_national_uwwtpC).",'graph_loadenteringByCompliance','middle');});</script>";
        
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Total load entering by compliance", $front, $aString_uwwtd_stat_national_uwwtpC).'</div></div>';
        //Load entering by compliance : number of agglomerations
        $front = '<svg id="graph_loadenteringByComplianceAgglomeration" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($aData_uwwtd_stat_agglomeration_uwwtpC).",'graph_loadenteringByComplianceAgglomeration','middle');});</script>";
        
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Number of treatment plant by compliance", $front, $aString_uwwtd_stat_agglomeration_uwwtpC).'</div></div>';
    $formResult.='</div>';
    
    //==============================================
    //=============== ROW 3
    //==============================================
    //Total load entering by treatment type

	$aData_uwwtd_stat_national_uwwtpT = array();
	$aString_uwwtd_stat_national_uwwtpT = array();

	$results = uwwtd_stat_national_uwwtp($options,'treatmenttype');
	$sum = 0;
	foreach ($results as $result){
		$aData_uwwtd_stat_national_uwwtpT[] = array(
				"value" => $result['loadentering_sum'],
				"label" => $result['field_uwwtreatmenttype_value_format'] .' ['.$result['loadentering_sum'].' pe]',
				"valueformat" => $result['loadentering_sum_format'],
                "color"=>isset($result['color'])?$result['color']:null
		);
		$sum+=$result['loadentering_sum'];
		$aString_uwwtd_stat_national_uwwtpT[]= array($result['field_uwwtreatmenttype_value_format'], $result['loadentering_sum_format'].' pe' );
	}
	$aString_uwwtd_stat_national_uwwtpT[]= array('Total',uwwtd_format_number($sum).' pe');
	$aString_uwwtd_stat_national_uwwtpT = theme('table', array("rows"=>$aString_uwwtd_stat_national_uwwtpT,"header"=>array("Compliance state", "Load entering")));
	//Load entering by treatment type : total agglomerations

	$aData_uwwtd_stat_agglomeration_uwwtpT = array();
	$aString_uwwtd_stat_agglomeration_uwwtpT = array();

	$results = uwwtd_stat_national_uwwtp($options,'treatmenttype');
	$sum = 0;
	foreach ($results as $result){
		$aData_uwwtd_stat_agglomeration_uwwtpT[] = array(
				"value" => $result['total_count'],
				"label" => $result['field_uwwtreatmenttype_value_format'] .' ['.$result['total_count'].']',
				"valueformat" => $result['total_count_format'],
                "color"=>isset($result['color'])?$result['color']:null
		);
		$sum+=$result['total_count'];
		$aString_uwwtd_stat_agglomeration_uwwtpT[] = array($result['field_uwwtreatmenttype_value_format'], $result['total_count_format']);
	}
	$aString_uwwtd_stat_agglomeration_uwwtpT[]= array('Total',uwwtd_format_number($sum));
    $aString_uwwtd_stat_agglomeration_uwwtpT = theme('table', array("rows"=>$aString_uwwtd_stat_agglomeration_uwwtpT,"header"=>array("Compliance state", "Number")));
    $formResult.='<h2 style="clear:both;">Waste water treatement plant : Load entering by treatment type</h2>';
    $formResult.='<div class="rows charts-row">';
        //Total load entering by treatment type
        $front = '<svg id="graph_loadenteringByTreatmenttype" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($aData_uwwtd_stat_national_uwwtpT).",'graph_loadenteringByTreatmenttype','middle');});</script>";
        
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Total load entering by treatment type", $front, $aString_uwwtd_stat_national_uwwtpT).'</div></div>';
        //Number of agglomerations by treatment type
        $front = '<svg id="graph_loadenteringByTreatmenttypeAgglomeration" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($aData_uwwtd_stat_agglomeration_uwwtpT).",'graph_loadenteringByTreatmenttypeAgglomeration','middle');});</script>";
        
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Number of treatment plant by treatment type", $front, $aString_uwwtd_stat_agglomeration_uwwtpT).'</div></div>';
    $formResult.='</div>';
    
    
    //==============================================
    //=============== ROW 4
    //==============================================
    
	//Total generated load by agglomeration

	$aData_uwwtd_stat_national_generated_by_agglomeration = array();
	$aString_uwwtd_stat_national_generated_by_agglomeration = array();
	
	$aData_uwwtd_stat_national_generated_by_agglomeration_count = array();
	$aString_uwwtd_stat_national_generated_by_agglomeration_count = array();
	
	

	$results = uwwtd_stat_national_generated_by_agglomeration($options);
    
	$sum = 0;
	$sum_count = 0;
	foreach ($results as $result){

		$aData_uwwtd_stat_national_generated_by_agglomeration[] = array(
				$result['type'],
				$result['generated_sum'],
		);
		$sum+=$result['generated_sum'];
		$aString_uwwtd_stat_national_generated_by_agglomeration[]= array($result['type'] , uwwtd_format_number($result['generated_sum']).' pe');
		
		$aData_uwwtd_stat_national_generated_by_agglomeration_count[] = array(
				$result['type'],
				$result['number'],
		);
		$sum_count+=$result['number'];
		$aString_uwwtd_stat_national_generated_by_agglomeration_count[]= array($result['type'] , uwwtd_format_number($result['number']));
		
		
        
	}
	$aString_uwwtd_stat_national_generated_by_agglomeration[]= array('Total',uwwtd_format_number($sum).' pe');
	$aString_uwwtd_stat_national_generated_by_agglomeration_count[]= array('Total',uwwtd_format_number($sum_count));
	$aString_uwwtd_stat_national_generated_by_agglomeration = theme('table', array("rows"=>$aString_uwwtd_stat_national_generated_by_agglomeration, "header"=>array("Size","Values")));
    $aString_uwwtd_stat_national_generated_by_agglomeration_count = theme('table', array("rows"=>$aString_uwwtd_stat_national_generated_by_agglomeration_count, "header"=>array("Size","Values")));
    //dsm($results);
    $formResult.='<h2 style="clear:both;">Agglomeration : generated load by agglomeration size</h2>';
    $formResult.='<div class="rows charts-row">';
        //Total generated load by agglomeration
		$legend = array("Generated load");
        $front =uwwtd_graph_render_column('graph_generatedByAgglomeration', $legend, $aData_uwwtd_stat_national_generated_by_agglomeration);
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Total generated load by agglomeration size", $front, $aString_uwwtd_stat_national_generated_by_agglomeration).'</div></div>';
        //Number of agglomerations by treatment type
		$legend = array("Number of agglomeration");
        $front =uwwtd_graph_render_column('graph_generatedByAgglomerationNumber', $legend, $aData_uwwtd_stat_national_generated_by_agglomeration_count);
		$formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Number of agglomeration by size", $front, $aString_uwwtd_stat_national_generated_by_agglomeration_count).'</div></div>';
    $formResult.='</div>';
    
    

    
    //==============================================
    //=============== ROW 6
    //==============================================
    
    
    //Total load entering and discharged

	$aData_uwwtd_load_ent_and_dis = array();
	$aString_uwwtd_load_ent_and_dis = '<table>';
    $aString_uwwtd_load_ent_and_dis.= '<tr><th>Parameter</th><th>Entering load (t/year)</th><th>Discharged load (t/year)</th></tr>';

	$results = uwwtd_stat_national_treatmentplant($options);
	foreach ($results as $result){

		$aData_uwwtd_load_ent_and_dis[] = array(
				"BOD",
				(float)$result['bodin_sum'],
				(float)$result['bodout_sum']
		);
        $aString_uwwtd_load_ent_and_dis .= '<tr><td>BOD</td><td>' . $result['bodin_sum_format'] . '</td><td>'.$result['bodout_sum_format'] . '</td></tr>';
		
		$aData_uwwtd_load_ent_and_dis[] = array(
				"COD",
				(float)$result['codin_sum'],
				(float)$result['codout_sum']
		);
		$aString_uwwtd_load_ent_and_dis .= '<tr><td>COD</td><td>' . $result['codin_sum_format'] . '</td><td>'.$result['codout_sum_format'] . '</td></tr>';
		
        $aData_uwwtd_load_ent_and_dis[] = array(
				"N",
				(float)$result['nin_sum'],
				(float)$result['nout_sum']
		);
		$aString_uwwtd_load_ent_and_dis .= '<tr><td>N</td><td>' . $result['nin_sum_format'] . '</td><td>'.$result['nout_sum_format'] . '</td></tr>';
		$aData_uwwtd_load_ent_and_dis[] = array(
				"P",
				(float)$result['pin_sum'],
				(float)$result['pout_sum']
		);
        $aString_uwwtd_load_ent_and_dis .= '<tr><td>P</td><td>' . $result['pin_sum_format'] . '</td><td>'.$result['pout_sum_format'] . '</td></tr>';
	}
    $aString_uwwtd_load_ent_and_dis.= '</table>';


	//BOD, COD, N, P concentration

	$aData_uwwtd_per_ent_and_dis = array();
	$aString_uwwtd_per_ent_and_dis = array();

	$results = uwwtd_stat_national_treatmentplant($options);
	foreach ($results as $result){

		$aData_uwwtd_per_ent_and_dis[] = array(
				"BOD",
				(float)($result['bodin_sum']/$result['uwwt_sum'])*bcpow(10, 9),
				(float)($result['bodout_sum']/$result['uwwt_sum'])*bcpow(10, 9)
		);
		$aString_uwwtd_per_ent_and_dis[]=array(
			'BOD',
			round($result['bodin_sum_format']/$result['uwwt_sum']*bcpow(10, 9) , 1), 
			round($result['bodout_sum_format']/$result['uwwt_sum']*bcpow(10, 9), 1),  
			round(((1- ($result['bodout_sum']/ $result['bodin_sum']))*100), 1) . ' %'
		);
		
        $aData_uwwtd_per_ent_and_dis[] = array(
				"COD",
				(float)($result['codin_sum']/$result['uwwt_sum'])*bcpow(10, 9),
				(float)($result['codout_sum']/$result['uwwt_sum'])*bcpow(10, 9)
		);
        $aString_uwwtd_per_ent_and_dis[]=array(
			'COD',
			round($result['codin_sum_format']/$result['uwwt_sum']*bcpow(10, 9), 1),
			round($result['codout_sum_format']/$result['uwwt_sum']*bcpow(10, 9), 1),
			round(((1- ($result['codout_sum_format']/ $result['codin_sum_format']))*100), 1) . ' %'
		);
		$aData_uwwtd_per_ent_and_dis[] = array(
				"N",
				(float)($result['nin_sum']/$result['uwwt_sum'])*bcpow(10, 9),
				(float)($result['nout_sum']/$result['uwwt_sum'])*bcpow(10, 9)
		);
        
        $aString_uwwtd_per_ent_and_dis[]=array(
			'N', 
			round(($result['nin_sum_format']/$result['uwwt_sum'])*bcpow(10, 9), 1) , 
			round(($result['nout_sum_format']/$result['uwwt_sum'])*bcpow(10, 9), 1), 
			round(((1- ($result['nout_sum_format']/ $result['nin_sum_format']))*100), 1) . ' %'
		);
		$aData_uwwtd_per_ent_and_dis[] = array(
				"P",
				(float)($result['pin_sum']/$result['uwwt_sum'])*bcpow(10, 9),
				(float)($result['pout_sum']/$result['uwwt_sum'])*bcpow(10, 9)
		);
        
        
		//FIX ME : why only 10^6
		$aString_uwwtd_per_ent_and_dis[]=array(
			'P', 
			round(($result['pin_sum']/$result['uwwt_sum'])*bcpow(10, 6), 1) , 
			round(($result['pout_sum']/$result['uwwt_sum'])*bcpow(10, 6), 1), 
			round(((1- ($result['pout_sum_format']/ $result['pin_sum_format']))*100), 1) . ' %'
		);

	}
    $aString_uwwtd_per_ent_and_dis= theme('table', array("header"=>array('Parameter','Entering (mg/l)','Discharged (mg/l)','Rate (%)'), "rows"=>$aString_uwwtd_per_ent_and_dis));
	 

    $legend =  array (
        'incoming',
        'discharged'
	);
    $formResult.='<h2 style="clear:both;">Waste water treatement plant : Total load entering and discharged</h2>';
    $formResult.='<div class="rows charts-row">';
        //Total load entering and discharged
        $front = uwwtd_graph_render_column('uwwtd_load_ent_and_dis', $legend, $aData_uwwtd_load_ent_and_dis);
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Total load entering and discharged", $front, $aString_uwwtd_load_ent_and_dis).'</div></div>';
        //BOD, COD, N, P concentration
        $front = uwwtd_graph_render_column('per_ent_and_dis', $legend, $aData_uwwtd_per_ent_and_dis);
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("BOD, COD, N, P concentration", $front, $aString_uwwtd_per_ent_and_dis).'</div></div>';
    $formResult.='</div>';
	
	
	//==============================================
    //=============== ROW 5
    //==============================================
    
    $ms_level = uwwtd_stat_national_ms_level_data($options);
    $sludge_destination = uwwtd_stat_national_ms_level_preprocess_sludge_chart($ms_level, $options['year']);
	$sludge_destination_str = '';
	if(!empty($sludge_destination)){
		$lines= array();
		foreach($sludge_destination as $dest){
			$lines[]=array(
				$dest['label'],
				$dest['valueformat'],
				
			);
		}
		$sludge_destination_str = theme('table', array("rows"=>$lines, "header"=>array("Destination","Values")));
	}
	
	$ww_reuse = '';
	if($ms_level[$options['year']]['waste_water']['Re-used']>0){
		$ww_reuse =$ms_level[$options['year']]['waste_water']['Re-used'].' m3 of treated waste water are re-used.';
		if($ms_level[$options['year']]['waste_water']['rate of re-used']){
			$ww_reuse.=' It represent '.$ms_level[$options['year']]['waste_water']['rate of re-used'].' % of the total volume treated';
		}
		$rep='';
		if($ms_level[$options['year']]['waste_water']['repartition']['agriculture']){
			$rep = ' in agriculture';
		}
		if($ms_level[$options['year']]['waste_water']['repartition']['industry']){
			$rep.= ($rep!=''?', ':'').' in industry';
		}
		if($ms_level[$options['year']]['waste_water']['repartition']['others']){
			$rep.= ($rep!=''?', ':'').' in others use.';
		}
		$ww_reuse.=($rep!=''?'This water is used ':'').$rep;
		
	}
    elseif($ms_level[$options['year']]['waste_water']['rate of re-used']){
		$ww_reuse.=' It represent '.$ms_level[$options['year']]['waste_water']['rate of re-used'].' % of treated waste water are re-used.';
		$rep='';
		if($ms_level[$options['year']]['waste_water']['repartition']['agriculture']){
			$rep = ' in agriculture';
		}
		if($ms_level[$options['year']]['waste_water']['repartition']['industry']){
			$rep.= ($rep!=''?', ':'').' in industry';
		}
		if($ms_level[$options['year']]['waste_water']['repartition']['others']){
			$rep.= ($rep!=''?', ':'').' in others use.';
		}
		$ww_reuse.=($rep!=''?'This water is used ':'').$rep;
	}
	else{
		$ww_reuse ='No information';
	}
	
    $formResult.='<h2 style="clear:both;">MS Level statistics</h2>';
    $formResult.='<div class="rows charts-row">';
        //Total load entering by treatment type
        $front = '<svg id="graph_sludge_dest" style="margin:10px;"/>';
        $front.= "<script>jQuery(document).ready(function(){display_piechart_custom(".json_encode($sludge_destination).",'graph_sludge_dest','middle');});</script>";
        
        if($ms_level[$options['year']]['sludge']['production']>0) $msg_sludge = "Production : ".$ms_level[$options['year']]['sludge']['production']." T DS/year";
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content">'.uwwtd_graph_render_flipcard("Sludge destination", $front, $sludge_destination_str, $msg_sludge).'</div></div>';

        
        $formResult.= '<div class="cell charts-rows-cell"><div class="cell-content"><div class="flot-title">Water re-use</div><p>'.$ww_reuse.'</p></div></div>';
    $formResult.='</div>';
	
	
	
    /*
	$formResult.='<div style="clear:both;">';
	$formResult.="% of collect system : collective, ias, without <br/>";
	$formResult.="% of network type: separative; <br/>";
	$formResult.='</div>';
	*/
	return  $formResult;
}





function uwwtd_graph_render_flipcard($title, $front, $back, $msg=''){
    $content = 
        '<div class="container flip">'
          .'<div class="leftgraph front">'
            . '<div class="flot-title">'
                .'<div class="flip-title">'.$title.'</div>'
                .'<img src="'.file_create_url(drupal_get_path('theme', 'uwwtd').'/images/corner-table-off.png').'" class="button-flipper to-table" title="See the data table" alt="See the data table">'
            . '</div>'
            . '<div class="flip-content"><b>'.$msg .'</b>'.$front.'</div>'
          .'</div>'

          .'<div class="leftgraph back">'
            . '<div class="flot-title flip-title-back">'
                .'<div class="flip-title">'.$title.'</div>'
                .'<img src="'.file_create_url(drupal_get_path('theme', 'uwwtd').'/images/corner-chart-off.png').'" class="button-flipper to-chart" title="See diagram" alt="See diagram">'
            . '</div>'
            . '<div class="flip-content"><b>'.$msg .'</b>'. $back .'</div>'
          .'</div>'
        .'</div>';
    return $content;
}

function uwwtd_graph_render_column($id, $legend, $rows){
  $chart = array(
    'id' => $id,
    'type' => 'ColumnChart',
    'legend' => $legend,
    'rows' => $rows,
    'width'=>510,
    'height'=>200,
  );
  return d3_draw($chart);
    
    
}

?>